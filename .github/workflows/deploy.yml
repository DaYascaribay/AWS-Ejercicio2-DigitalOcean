name: Deploy to DigitalOcean Droplet

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 146.190.160.148 >> ~/.ssh/known_hosts

    - name: Deploy to Droplet
      run: |
        ssh root@146.190.160.148 << 'EOF'
          set -e  # Detener el script si ocurre algÃºn error

          echo "ðŸ” Verificando Docker..."
          docker --version || { echo "âŒ Docker no estÃ¡ instalado"; exit 1; }

          echo "ðŸ“ Entrando al proyecto..."
          cd /root/AWS-Ejercicio2-DigitalOcean

          echo "ðŸ”„ Haciendo pull del repositorio..."
          git pull origin main

          echo "ðŸ›‘ Deteniendo y eliminando contenedor anterior..."
          docker rm -f mi_app || true

          echo "ðŸ³ Construyendo imagen Docker..."
          docker build -t mi_app .

          echo "ðŸš€ Ejecutando nuevo contenedor..."
          docker run -d --name mi_app -p 999:999 mi_app

          echo "âœ… Despliegue completado."
        EOF
